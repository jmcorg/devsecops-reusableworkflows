name: "buildscanandsign"

on:
   workflow_call:
     inputs:
      dockerfilepath:
        description: The path of dockerfile 
        type: string
        required: false
        default: '.'

env:
  REGISTRY: ghcr.io
  # github.repository as <account>/<repo>
  IMAGE_NAME:  '${{ github.event.repository.name }}'
  GAR_NAME: 'asia-south1-docker.pkg.dev'
  GAR_REPO_NAME: 'artifact-scanning-repo'
  GOOGLE_CLOUD_PROJECT: 'jmc-devsecops'
  tag: 'default'
  TAG_VERSION: 'default'
  workflow_name: 'gcp-invalid'
  IMAGE_NAME_WITH_TAG: 'default:default'
  PAC_ACTION: 'continue'
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      packages: write
      actions: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Build Docker image
        id: docker-build
        run: |
              echo "Build in progress"
              cd ${{inputs.dockerfilepath}}
              pwd
              ls -lart
              
              export IMAGE_ID=${GAR_NAME}/${GOOGLE_CLOUD_PROJECT}/${GAR_REPO_NAME}/$IMAGE_NAME
              VERSION=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')
              # Strip "v" prefix from tag name
              [[ "${{ github.ref }}" == "refs/tags/"* ]] && VERSION=$(echo $VERSION | sed -e 's/^v//')
              export TAG=${GITHUB_RUN_ID}-$VERSION-$(TZ='Asia/Calcutta' date "+%Y%m%d.%H%M")
              # Change all uppercase to lowercase
              IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')

              docker build . --file ./Dockerfile --tag $TAG --label "runnumber=${GITHUB_RUN_ID}"
              docker image ls
              echo "imageurlwithtag=$IMAGE_ID:$TAG" >> $GITHUB_OUTPUT

      - name: Authenticating to gcloud
        id: auth-gcloud
        uses: google-github-actions/auth@v1.1.1
        with:
          workload_identity_provider: projects/203546026970/locations/global/workloadIdentityPools/github-jomcyg/providers/github 
          service_account: sa-jomcyggithub-gcloudauth@jmc-devsecops.iam.gserviceaccount.com
          access_token_lifetime: '240s'
      - name: docker-push to GAR
        id: docker-push
        run: |
            echo "Authenticating to GAR..."
            gcloud auth configure-docker asia-south1-docker.pkg.dev
            echo " Pushing the Image to GAR"
            docker push $IMAGE_ID:$TAG_VERSION
            docker push ${{ steps.docker-build.outputs.imageurlwithtag }}
            # docker image inspect $IMAGE_ID:$TAG_VERSION --format '{{index .RepoDigests 0}}' > image-digest.txt &&
            # cat image-digest.txt
            