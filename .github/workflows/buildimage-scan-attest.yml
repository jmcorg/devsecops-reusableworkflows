name: "buildscanandsign"

on:
   workflow_call:
     inputs:
      dockerfilepath:
        description: The path of dockerfile 
        type: string
        required: false
        default: '.'

env:
  REGISTRY: ghcr.io
  # github.repository as <account>/<repo>
  IMAGE_NAME:  '${{ github.event.repository.name }}'
  GAR_NAME: 'asia-south1-docker.pkg.dev'
  GAR_REPO_NAME: 'artifact-scanning-repo'
  tag: 'default'
  TAG_VERSION: 'default'
  workflow_name: 'gcp-invalid'
  IMAGE_NAME_WITH_TAG: 'default:default'
  PAC_ACTION: 'continue'
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      packages: write
      actions: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Build Docker image
        id: docker-build
        run: |
              echo "Build in progress"
              cd ${{inputs.dockerfilepath}}
              pwd
              ls -lart
              echo "Docker file is in ${{inputs.dockerfilepath}}"
              export GOOGLE_CLOUD_PROJECT="jmc-devsecops"
              export IMAGE_ID=${GAR_NAME}/${GOOGLE_CLOUD_PROJECT}/${GAR_REPO_NAME}/$IMAGE_NAME
              docker build . --file ./Dockerfile --tag $IMAGE_NAME --label "runnumber=${GITHUB_RUN_ID}"
      - name: Authenticating to gcloud
        id: auth-gcloud
        uses: google-github-actions/auth@v1.1.1
        with:
          workload_identity_provider: projects/203546026970/locations/global/workloadIdentityPools/github-jomcyg/providers/github 
          service_account: sa-jomcyggithub-gcloudauth@jmc-devsecops.iam.gserviceaccount.com
          access_token_lifetime: '240s'
      - name: docker-push
        id: docker-push
        run: |
            
            export IMAGE_ID=${GAR_NAME}/${GOOGLE_CLOUD_PROJECT}/${GAR_REPO_NAME}/$IMAGE_NAME
            # Change all uppercase to lowercase
            IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')

            VERSION=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')
            # Strip "v" prefix from tag name
            [[ "${{ github.ref }}" == "refs/tags/"* ]] && VERSION=$(echo $VERSION | sed -e 's/^v//')
            export tag=$VERSION-$(TZ='Asia/Calcutta' date "+%Y%m%d.%H%M")
            echo tag=$tag >> $GITHUB_ENV
            export TAG_VERSION=$tag
            export TAG_VERSION=${GITHUB_RUN_ID}-$tag
            docker tag $IMAGE_NAME $IMAGE_ID:$TAG_VERSION
            docker image ls


            echo "Authenticating to GAR..."
            gcloud auth configure-docker asia-south1-docker.pkg.dev
            echo " Pushing the Image to GAR"
            docker push $IMAGE_ID:$TAG_VERSION